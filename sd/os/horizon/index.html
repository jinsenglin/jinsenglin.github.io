<html>
  <head>
    <script src="https://bramp.github.io/js-sequence-diagrams/js/raphael-min.js"></script>
    <script src="https://bramp.github.io/js-sequence-diagrams/js/underscore-min.js"></script>
    <script src="https://bramp.github.io/js-sequence-diagrams/js/sequence-diagram-min.js"></script>
  </head>
  <body>
    <div id="info">
      <div>openstack_dashboard/dashboards/project/stacks/panel.py 中明確宣告需要 permission 'openstack.services.orchestration'</div>
      <div>user.has_perm() 會比對當前 user 物件的 get_all_permissions() 內容是否包含 permission 'openstack.services.orchestration', 若找不到就無權使用</div>
      <div>user.has_perm() & get_all_permissions() 的實作在 openstack_auth/backend.py</div>
      <div>user.has_perms() 的實作在 openstack_auth/user.py</div>
      <div>policy_check() 的實作在 openstack_auth/policy.py 的 check(), 透過 openstack_dashboard/settings.py 指定 POLICY_CHECK_FUNCTION 來關聯</div>
      <div>enforce() 的實作在 oslo_policy/policy.py</div>
    </div>
    <div id="diagram"></div>
      <script>
        var data = "browser->openstack_dashboard/templates/base.html: request";
        data += "\nopenstack_dashboard/templates/base.html->horizon/templates/horizon/common/_sidebar.html: include";
        data += "\nhorizon/templates/horizon/common/_sidebar.html->horizon_nav: use";
        data += "\nhorizon_nav->can_access: invoke";
        data += "\ncan_access->allowed: invoke";
        data += "\nallowed->_can_access: invoke";
        data += "\n_can_access->policy_check: invoke";
        data += "\npolicy_check->_check_credentials: invoke";
        data += "\n_check_credentials->enforce: invoke";
        data += "\nenforce->policy_rules: check";
        data += "\nhorizon_nav->accessible panels: output";
        data += "\nhorizon/templates/horizon/_sidebar.html->accessible panels: render";
        data += "\nhorizon/templates/horizon/_sidebar.html->has_permissions: use";
        data += "\nhas_permissions->user.has_perms: invoke";
        data += "\nuser.has_perms->user.has_perm: invoke";
        data += "\nuser.has_perm->permissions: check";
        data += "\nhorizon/templates/horizon/_sidebar.html->has_permissions_on_list: use";
        data += "\nhas_permissions_on_list->has_permissions: invoke";
        data += "\nhas_permissions->permissions: check";
        data += "\nhorizon/templates/horizon/_sidebar.html->filtered panels: output";
        data += "\nhorizon/templates/horizon/_sidebar.html->filtered panels: render";
        data += "\nhorizon/templates/horizon/_sidebar.html->browser: response";
        var diagram = Diagram.parse(data);
        diagram.drawSVG("diagram", {theme: 'simple'});
      </script>
    </div>
  </body>
</html>
